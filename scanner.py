import requests
from urllib.parse import urlparse
import logging
from database import SessionLocal, Target, ScanResult

logging.basicConfig(filename='scanner.log', level=logging.DEBUG, 
                    format='%(asctime)s %(levelname)s: %(message)s')

def add_target(url):
    if not validate_url(url):
        logging.error(f"Invalid URL format: {url}")
        return False, "Invalid URL format. Please enter a valid URL starting with http:// or https://."
    session = SessionLocal()
    target = Target(url=url)
    session.add(target)
    session.commit()
    session.close()
    logging.debug(f"Added target URL: {url}")
    return True, "Target added successfully."

def validate_url(url):
    parsed = urlparse(url)
    return bool(parsed.scheme) and bool(parsed.netloc)

def scan_sql_injection(url):
    if not validate_url(url):
        logging.error(f"Invalid URL format for SQL Injection scan: {url}")
        return False, "Invalid URL format"
    
    payload = "' OR '1'='1"
    test_url = f"{url}?id={payload}"
    response = requests.get(test_url)
    logging.debug(f"SQL Injection test URL: {test_url}")
    logging.debug(f"SQL Injection response: {response.text}")
    if "syntax error" in response.text.lower():
        return True, "SQL Injection vulnerability detected"
    return False, "No SQL Injection vulnerability detected"

def scan_xss(url):
    if not validate_url(url):
        logging.error(f"Invalid URL format for XSS scan: {url}")
        return False, "Invalid URL format"
    
    payload = "<script>alert('XSS')</script>"
    test_url = f"{url}?q={payload}"
    response = requests.get(test_url)
    logging.debug(f"XSS test URL: {test_url}")
    logging.debug(f"XSS response: {response.text}")
    if payload in response.text:
        return True, "XSS vulnerability detected"
    return False, "No XSS vulnerability detected"

def save_scan_result(target_id, target_url, vulnerability_type, description, remediation):
    session = SessionLocal()
    result = ScanResult(
        target_id=target_id,
        target_url=target_url,
        vulnerability_type=vulnerability_type,
        description=description,
        remediation=remediation
    )
    session.add(result)
    session.commit()
    session.close()
    logging.debug(f"Saved scan result: {result}")

def get_remediation_suggestions(vulnerability_type):
    suggestions = {
        "SQL Injection": "Use prepared statements and parameterized queries.",
        "XSS": "Use proper input validation and encoding."
    }
    return suggestions.get(vulnerability_type, "No suggestions available.")