<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automated Vulnerability Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const message = "{{ message }}";
      if (message) {
        alert(message);
      }
    });

    function generateReport() {
      fetch('/today_scans')
        .then(response => response.json())
        .then(data => {
          const reportList = document.getElementById('reportList');
          reportList.innerHTML = `
            <h1 class="text-center mb-4">Scan Report</h1>
            <ul class="list-group">
              ${data.map(result => `
                <li class="list-group-item">
                  <strong>Target:</strong> ${result.target_url}<br>
                  <strong>Type:</strong> ${result.vulnerability_type}<br>
                  <strong>Description:</strong> ${result.description}<br>
                  <strong>Remediation:</strong> ${result.remediation}<br>
                  <strong>Found At:</strong> ${result.found_at}
                </li>
              `).join('')}
            </ul>
          `;
          const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
          reportModal.show();
        })
        .catch(error => console.error('Error fetching today\'s scans:', error));
    }

    function printReport() {
      const reportContent = document.getElementById('reportList').innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = reportContent;
      window.print();
      document.body.innerHTML = originalContent;
      window.location.reload();
    }
  </script>

</head>

<body>
  <div class="container">
    <header>
      <h1 class="mb-4">AUTOMATED VULNERABILITY SCANNER</h1>
      <div class="welcome-user mb-3">Welcome, <span id="username">{{ username }}</span></div>
      <form action="/logout" method="post" class="form-logout">
        <button type="submit" class="logout-button">Logout <i class="bi bi-box-arrow-right"></i></button>
      </form>
    </header>

    <div class="alert alert-danger" id="invalid-link-alert" style="display: none;">
      <button type="button" class="btn-close"
        onclick="document.getElementById('invalid-link-alert').style.display = 'none';"></button>
      Invalid link! Please enter a valid URL.
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div>
      {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}


    <form action="/add_target" method="post" class="form-group">
      <label for="url">Target URL:</label>
      <input type="text" id="url" name="url" required>
      <button type="submit">Add <i class="bi bi-plus-circle"></i></button>
    </form>

    <div class="targets-box">
      <div class="row align-items-center mb-3">
        <div class="col">
          <h2 class="text-center">Target</h2>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#infoModal">
            <i class="bi bi-info-circle float-end"></i>
          </button>
        </div>
      </div>
      <ul id="targetList" class="list-group">
        {% if latest_target and not latest_target.is_scanned %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <span>{{ latest_target.url }}</span>
            <a class="btn btn-primary" href="/scan/{{ latest_target.id }}">Scan <i class="bi bi-search"></i></a>
          </div>
        </li>
        {% else %}
        <li class="list-group-item">
          <p class="mb-0">No target added yet.</p>
        </li>
        {% endif %}
      </ul>
    </div>

    <div class="results-box">
      <h2 class="text-center mb-4">Latest Scan Result</h2>
      {% if latest_scan_result %}
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ latest_scan_result.target_url }}</h5>
          <p class="card-text">
            <strong>Type:</strong> {{ latest_scan_result.vulnerability_type }}<br>
            <strong>Description:</strong> {{ latest_scan_result.description }}<br>
            <strong>Remediation:</strong> {{ latest_scan_result.remediation }}<br>
            <strong>Found At:</strong> {{ latest_scan_result.found_at }}
          </p>
        </div>
      </div>
      {% else %}
      <p class="text-center">No scan results available.</p>
      {% endif %}
    </div>
    <div style="text-align: center;">
      <button class="btn btn-primary" onclick="generateReport()">Generate Report <i
          class="bi bi-journal-text"></i></button>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#historicalScansModal">View
        Historical Scans <i class="bi bi-clock-history"></i></button>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
          </div>
          <div class="modal-body">
            <div id="reportList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close <i class="bi bi-x"></i></button>
            <button type="button" class="btn btn-primary" onclick="printReport()">Print <i
                class="bi bi-printer-fill"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="historicalScansModal" tabindex="-1" aria-labelledby="historicalScansModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
          </div>
          <div class="modal-body">
            <h1 class="text-center mb-4">Historical Scan Results</h1>
            <ul class="list-group">
              {% for result in scan_results %}
              <li class="list-group-item">
                <strong>Target:</strong> {{ result.target_url }}<br>
                <strong>Type:</strong> {{ result.vulnerability_type }}<br>
                <strong>Description:</strong> {{ result.description }}<br>
                <strong>Remediation:</strong> {{ result.remediation }}<br>
                <strong>Found At:</strong> {{ result.found_at }}
              </li>
              {% endfor %}
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close <i class="bi bi-x"></i></button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="infoModalLabel">Information</h4>
          </div>
          <div class="modal-body">
            <h5 style="text-align: center;">SQL Injection</h5>
            <p>
              SQL injection (SQLi) is a web security vulnerability that allows an attacker to interfere with the queries
              an
              application makes to its database. This can enable the attacker to view, modify, or delete data that they
              shouldn't
              normally have access to, such as user information, passwords, or credit card details.
            </p>
            <a class="btn btn-primary" href="https://en.wikipedia.org/wiki/SQL_injection" target="_blank">Learn more <i
                class="bi bi-book-fill"></i></a>
            <br>
            <br>
            <h5 style="text-align: center;">Cross-Site Scripting Vulnerability</h5>
            <p>
              Cross-Site Scripting (XSS) is a type of security vulnerability found in web applications. It allows
              attackers to inject
              malicious scripts into web pages viewed by other users. These scripts can then execute in the user's
              browser,
              potentially leading to data theft, session hijacking, or other malicious activities.
            </p>
            <a class="btn btn-primary" href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank">Learn
              more <i class="bi bi-book-fill"></i></a>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close <i class="bi bi-x"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>